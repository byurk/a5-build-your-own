name: Autograding Tests
'on':
- push
- repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Core tests
      id: core-tests
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: Core tests
        setup-command: ''
        command: pytest tests/test_tools.py tests/test_tool_graph.py tests/test_retriever.py -v
        timeout: 60
        max-score: 15

    - name: Documentation complete
      id: documentation-complete
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: Documentation complete
        setup-command: ''
        command: python tests/verify_submission.py
        timeout: 10
        max-score: 40

    - name: Extension validation
      id: extension-validation
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: Extension validation
        setup-command: ''
        command: |
          python -c "
          import re
          from pathlib import Path

          graph_code = Path('ai_in_loop/graph.py').read_text()
          tools_code = Path('ai_in_loop/tools.py').read_text()

          node_count = graph_code.count('graph.add_node(')
          # Count @tool decorators at start of line (not in comments)
          tool_count = len(re.findall(r'^\s*@tool\s*$', tools_code, re.MULTILINE))

          # Baseline: 2 nodes, 2 tools - student must add at least one
          assert node_count > 2 or tool_count > 2, (
              f'Extension required: found {node_count} nodes and {tool_count} tools. '
              f'Add a node to graph.py OR a tool to tools.py.'
          )
          print(f'Extension found: {node_count} nodes, {tool_count} tools')
          "
        timeout: 10
        max-score: 25

    - name: Application prompt sections
      id: application-prompt-sections
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: Application prompt sections
        setup-command: ''
        command: |
          python -c "
          from pathlib import Path
          prompt = Path('prompts/application_prompt.md').read_text()
          assert '# Persona' in prompt, 'Missing # Persona section'
          assert '# Task' in prompt, 'Missing # Task section'
          assert '# Citations' in prompt, 'Missing # Citations section'
          assert len(prompt) >= 300, f'Prompt too short ({len(prompt)} chars, need 300)'
          assert 'REPLACE_ME' not in prompt, 'Prompt still contains REPLACE_ME placeholders'
          print('Application prompt has all required sections')
          "
        timeout: 10
        max-score: 20

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        CORE-TESTS_RESULTS: "${{steps.core-tests.outputs.result}}"
        DOCUMENTATION-COMPLETE_RESULTS: "${{steps.documentation-complete.outputs.result}}"
        EXTENSION-VALIDATION_RESULTS: "${{steps.extension-validation.outputs.result}}"
        APPLICATION-PROMPT-SECTIONS_RESULTS: "${{steps.application-prompt-sections.outputs.result}}"
      with:
        runners: core-tests,documentation-complete,extension-validation,application-prompt-sections
